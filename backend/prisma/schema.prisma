generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CONCIERGE
  COUNCIL
  PROPERTY_MANAGER
}

enum MoveType {
  MOVE_IN
  MOVE_OUT
  DELIVERY
  RENO
}

enum BookingStatus {
  SUBMITTED
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum NotifyEvent {
  APPROVED
  REJECTED
  SUBMITTED
}

model User {
  id           String     @id @default(uuid()) @db.Uuid
  name         String
  email        String     @unique
  role         UserRole
  passwordHash String     @map("password_hash")
  createdAt    DateTime   @default(now()) @map("created_at")
  bookings     Booking[]  @relation("CreatedBookings")
  approvals    Booking[]  @relation("ApprovedBookings")
  auditLogs    AuditLog[]
  resetTokens  PasswordResetToken[]

  @@map("users")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model Booking {
  id                 String        @id @default(uuid()) @db.Uuid
  createdById        String        @map("created_by") @db.Uuid
  residentName       String        @map("resident_name")
  residentEmail      String        @map("resident_email")
  residentPhone      String        @map("resident_phone")
  unit               String
  companyName        String?       @map("company_name")
  moveType           MoveType      @map("move_type")
  moveDate           DateTime      @db.Date @map("move_date")
  startDatetime      DateTime      @map("start_datetime")
  endDatetime        DateTime      @map("end_datetime")
  elevatorRequired   Boolean       @default(false) @map("elevator_required")
  loadingBayRequired Boolean       @default(false) @map("loading_bay_required")
  notes              String?
  status             BookingStatus @default(SUBMITTED)
  approvedById       String?       @map("approved_by") @db.Uuid
  lastPaymentReminderSentAt DateTime? @map("last_payment_reminder_sent_at")
  approvedAt         DateTime?     @map("approved_at")
  publicUnitMask     String?       @map("public_unit_mask")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  createdBy User      @relation("CreatedBookings", fields: [createdById], references: [id])
  approvedBy User?    @relation("ApprovedBookings", fields: [approvedById], references: [id])
  documents  Document[]
  auditLogs  AuditLog[]

  @@index([startDatetime])
  @@index([status])
  @@index([moveDate])
  @@index([status, startDatetime])
  @@index([createdById, createdAt])
  @@map("bookings")
}

model Document {
  id           String   @id @default(uuid()) @db.Uuid
  bookingId    String   @map("booking_id") @db.Uuid
  originalName String   @map("original_name")
  storagePath  String   @map("storage_path")
  mimeType     String   @map("mime_type")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model NotificationRecipient {
  id        String        @id @default(uuid()) @db.Uuid
  name      String?
  email     String
  enabled   Boolean       @default(true)
  notifyOn  NotifyEvent[] @map("notify_on")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  @@map("notification_recipients")
}

model AppSetting {
  id                                          String   @id @default(uuid()) @db.Uuid
  smtpHost                                    String?  @map("smtp_host")
  smtpPort                                    Int?     @map("smtp_port")
  smtpSecure                                  Boolean  @default(false) @map("smtp_secure")
  smtpUsername                                String?  @map("smtp_username")
  smtpPasswordEncrypted                       String?  @map("smtp_password_encrypted")
  fromName                                    String?  @map("from_name")
  fromEmail                                   String?  @map("from_email")
  includeResidentContactInApprovalEmails      Boolean  @default(false) @map("include_resident_contact_in_approval_emails")
  reminderEnabled                             Boolean  @default(true) @map("reminder_enabled")
  invoiceNinjaEnabled                         Boolean  @default(false) @map("invoice_ninja_enabled")
  unpaidPaymentReminderEnabled                Boolean  @default(false) @map("unpaid_payment_reminder_enabled")
  createdAt                                   DateTime @default(now()) @map("created_at")
  updatedAt                                   DateTime @updatedAt @map("updated_at")

  @@map("app_settings")
}

model AuditLog {
  id          String    @id @default(uuid()) @db.Uuid
  actorUserId String    @map("actor_user_id") @db.Uuid
  action      String
  bookingId   String?   @map("booking_id") @db.Uuid
  metadataJson Json?    @map("metadata_json")
  timestamp   DateTime  @default(now())

  actor   User     @relation(fields: [actorUserId], references: [id])
  booking Booking? @relation(fields: [bookingId], references: [id])

  @@map("audit_log")
}

model PaymentsLedger {
  id              String         @id @default(uuid()) @db.Uuid
  clientId        String         @map("client_id")
  invoiceId       String         @unique @map("invoice_id")
  billingPeriod   String         @map("billing_period")
  feeType         String         @map("fee_type")
  unit            String?
  paidAt          DateTime       @map("paid_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  dismissed       Boolean        @default(false)
  dismissedReason String?        @map("dismissed_reason")
  dismissedAt     DateTime?      @map("dismissed_at")
  moveApprovals   MoveApproval[]

  @@map("payments_ledger")
}

model MoveApproval {
  id            String         @id @default(uuid()) @db.Uuid
  moveRequestId String         @map("move_request_id")
  clientId      String         @map("client_id")
  invoiceId     String         @map("invoice_id")
  billingPeriod String         @map("billing_period")
  approvedAt    DateTime       @default(now()) @map("approved_at")
  payment       PaymentsLedger @relation(fields: [invoiceId], references: [invoiceId])

  @@map("move_approvals")
}
